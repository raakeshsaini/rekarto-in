---
import BaseLayout from "../../layouts/BaseLayout.astro";
import Breadcrumbs from "../../components/ui/Breadcrumbs.astro";
import BlogCard from "../../components/blog/BlogCard.astro";
import { getCollection } from "astro:content";

const breadcrumbItems = [{ label: "Blog" }];
const PAGE_SIZE = 12;
const fallbackImage = "/images/blog/fallback.webp";

const allPosts = (await getCollection("blog")).sort(
  (a, b) => b.data.publishDate.getTime() - a.data.publishDate.getTime()
);

const posts = allPosts.slice(0, PAGE_SIZE);
const totalPages = Math.ceil(allPosts.length / PAGE_SIZE);
---

<BaseLayout title="Blog | ReKarto">
  <section class="max-w-6xl mx-auto px-4 sm:px-6 space-y-10">

    <!-- Header -->
    <div class="space-y-4">
      <Breadcrumbs items={breadcrumbItems} />

      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
          <h1 class="text-xl font-semibold text-zinc-900">Blog</h1>
          <p class="text-sm text-zinc-600">
            Practical insights on thrift, supply & offline business.
          </p>
        </div>

        <input
          id="blog-search"
          type="search"
          placeholder="Search blog…"
          class="border border-zinc-200 rounded-md px-4 py-2 w-full sm:w-72 text-sm"
        />
      </div>
    </div>

    <!-- Blog Grid -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
      {posts.map(post => (
        <div
          data-blog-card
          data-search={(post.data.title + " " + post.data.description).toLowerCase()}
        >
          <BlogCard
            href={`/blog/${post.slug}`}
            title={post.data.title}
            excerpt={post.data.description}
            date={post.data.publishDate.toDateString()}
            image={post.data.image || fallbackImage}
          />
        </div>
      ))}
    </div>

    <!-- Pagination -->
    {totalPages > 1 && (
      <div class="flex justify-end text-sm text-zinc-600">
        <a href="/blog/page/2" class="underline hover:text-black">
          Older →
        </a>
      </div>
    )}
  </section>

<!-- Search Script -->
<script>
  const input = document.getElementById("blog-search");

  if (input instanceof HTMLInputElement) {
    const cards = document.querySelectorAll("[data-blog-card]");

    input.addEventListener("input", () => {
      const q = input.value.toLowerCase().trim();

      cards.forEach((card) => {
        if (!(card instanceof HTMLElement)) return;

        const text = card.dataset.search || "";
        card.style.display = text.includes(q) ? "" : "none";
      });
    });
  }
</script>

</BaseLayout>
